<!DOCTYPE html>
<html lang="pt-AO">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configura√ß√µes - ELO Commerce</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {background:#000;color:#f5f5f5;font-family:"Poppins",sans-serif;}
    .navbar{background:linear-gradient(90deg,#b8860b 0%,#000 100%);}
    .navbar-brand{color:#fff!important;font-weight:bold;}
    .container{max-width:750px;margin-top:100px;background:#111;border:1px solid #222;border-radius:12px;padding:30px;
      box-shadow:0 0 15px rgba(255,215,0,0.1);}
    .btn-gold{background-color:#b8860b;color:#fff;border:none;border-radius:25px;padding:10px 24px;font-weight:600;
      transition:0.3s;}
    .btn-gold:hover{background-color:#ffcc00;color:#000;transform:scale(1.05);}
    .btn-danger-custom{background-color:#b02a37;color:#fff;border-radius:25px;padding:10px 24px;font-weight:600;
      border:none;transition:0.3s;}
    .btn-danger-custom:hover{background-color:#dc3545;transform:scale(1.05);}
    .form-control,input[type=file]{background-color:#222;color:#fff;border:1px solid #333;}
    .form-control:focus{border-color:#b8860b;box-shadow:none;background-color:#1a1a1a;color:#fff;}
    .profile-img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid #b8860b;}
    .preview-link{color:#ffcc00;font-weight:500;}
    .modal-content{background-color:#111;color:#fff;border:1px solid #b8860b;border-radius:15px;}
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="painel.html">‚öôÔ∏è Configura√ß√µes</a>
    <button class="btn btn-outline-light ms-auto" id="logoutBtn">Sair</button>
  </div>
</nav>

<div class="container">
  <h2 class="text-warning text-center mb-4">Editar Perfil</h2>

  <!-- Perfil -->
  <div class="text-center mb-4">
    <img id="fotoPerfil" src="https://via.placeholder.com/120" class="profile-img" alt="Foto de Perfil">
    <div class="mt-3"><input type="file" id="novaFoto" accept="image/*"></div>
  </div>

  <form id="configForm">
    <div class="mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" id="nome" required></div>
    <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="email" required></div>
    <div class="mb-3"><label class="form-label">Nova Senha</label>
      <input type="password" class="form-control" id="senha" placeholder="Deixe em branco se n√£o quiser mudar"></div>
    <button type="submit" class="btn-gold w-100 mt-3">Salvar Altera√ß√µes</button>
  </form>

  <hr class="my-4 text-secondary">

  <!-- Loja personalizada -->
  <h3 class="text-warning text-center mb-3">Personalizar Loja</h3>
  <form id="lojaForm">
    <div class="mb-3">
      <label class="form-label">Nome da Loja</label>
      <input type="text" class="form-control" id="nomeLoja" placeholder="Ex: Boutique Afro Chic" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Link da Loja</label>
      <div class="input-group">
        <span class="input-group-text bg-dark text-warning border-0">elo-commerce.com/</span>
        <input type="text" class="form-control" id="linkLoja" placeholder="minha-loja" required>
      </div>
      <small class="preview-link" id="previewLink"></small>
    </div>
    <button type="submit" class="btn-gold w-100 mt-2">Salvar Loja</button>
  </form>

  <hr class="my-4 text-secondary">

  <div class="d-flex justify-content-between">
    <button id="baixarDadosBtn" class="btn-gold w-50 me-2">üì¶ Baixar meus dados</button>
    <button id="deleteAccountBtn" class="btn-danger-custom w-50">üóëÔ∏è Excluir Conta</button>
  </div>
</div>

<!-- Modal de exclus√£o -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title text-warning">‚ö†Ô∏è Confirmar Exclus√£o</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Esta a√ß√£o √© <strong>irrevers√≠vel</strong>. Digite sua senha para confirmar.</p>
        <input type="password" id="confirmPassword" class="form-control" placeholder="Senha atual">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="confirmDeleteBtn" class="btn-danger-custom">Excluir Definitivamente</button>
      </div>
    </div>
  </div>
</div>

<footer class="text-center mt-5 py-3 bg-black text-secondary">
  &copy; 2025 ELO Commerce. Todos os direitos reservados.
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, updateEmail, updatePassword, signOut, deleteUser, EmailAuthProvider, reauthenticateWithCredential } 
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, query, where } 
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } 
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAN_7vyt0XcOt6NvOE6MDoBCajUjhToCR0",
    authDomain: "elo-ecommerce-ecd87.firebaseapp.com",
    projectId: "elo-ecommerce-ecd87",
    storageBucket: "elo-ecommerce-ecd87.appspot.com",
    messagingSenderId: "375574231770",
    appId: "1:375574231770:web:78279cb6aac72c454703e3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const fotoPerfil=document.getElementById("fotoPerfil");
  const novaFoto=document.getElementById("novaFoto");
  const form=document.getElementById("configForm");
  const lojaForm=document.getElementById("lojaForm");
  const linkLoja=document.getElementById("linkLoja");
  const preview=document.getElementById("previewLink");

  // Atualiza pr√©via do link em tempo real
  linkLoja.addEventListener("input",()=> {
    preview.textContent=`‚û°Ô∏è elo-commerce.com/${linkLoja.value.trim()}`;
  });

  let userEmail="";

  onAuthStateChanged(auth,async user=>{
    if(!user){window.location.href="login.html";return;}
    userEmail=user.email;

    // Perfil
    const userSnap=await getDoc(doc(db,"usuarios",userEmail));
    if(userSnap.exists()){
      const d=userSnap.data();
      document.getElementById("nome").value=d.nome||"";
      document.getElementById("email").value=user.email;
      fotoPerfil.src=d.foto||"https://via.placeholder.com/120";
    }

    // Loja
    const lojaSnap=await getDoc(doc(db,"lojas",userEmail));
    if(lojaSnap.exists()){
      const d=lojaSnap.data();
      document.getElementById("nomeLoja").value=d.nomeLoja||"";
      document.getElementById("linkLoja").value=d.linkLoja||"";
      preview.textContent=`‚û°Ô∏è elo-commerce.com/${d.linkLoja}`;
    }
  });

  document.getElementById("logoutBtn").addEventListener("click",async()=>{await signOut(auth);window.location.href="login.html";});

  // Salvar perfil
  form.addEventListener("submit",async e=>{
    e.preventDefault();
    const user=auth.currentUser;if(!user)return alert("Fa√ßa login novamente.");
    const nome=document.getElementById("nome").value;
    const email=document.getElementById("email").value;
    const senha=document.getElementById("senha").value;
    try{
      if(email!==user.email)await updateEmail(user,email);
      if(senha)await updatePassword(user,senha);
      let fotoURL=fotoPerfil.src;
      if(novaFoto.files.length>0){
        const file=novaFoto.files[0];
        const fileRef=ref(storage,"usuarios/"+user.uid+".jpg");
        await uploadBytes(fileRef,file);
        fotoURL=await getDownloadURL(fileRef);
      }
      await setDoc(doc(db,"usuarios",email),{nome,email,foto:fotoURL,atualizadoEm:new Date()});
      alert("‚úÖ Perfil atualizado!");
      window.location.reload();
    }catch(err){alert("Erro: "+err.message);}
  });

  // Salvar loja personalizada
  lojaForm.addEventListener("submit",async e=>{
    e.preventDefault();
    const nomeLoja=document.getElementById("nomeLoja").value.trim();
    const linkLoja=document.getElementById("linkLoja").value.trim().toLowerCase().replace(/\s+/g,"-");
    try{
      await setDoc(doc(db,"lojas",userEmail),{email:userEmail,nomeLoja,linkLoja,atualizadoEm:new Date()});
      alert("üõçÔ∏è Loja personalizada salva com sucesso!");
    }catch(err){alert("Erro ao salvar loja: "+err.message);}
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
