<!DOCTYPE html>
<html lang="pt-AO">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Usu√°rio - ELO Commerce</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #0a0f24;
      color: #fff;
      font-family: "Poppins", sans-serif;
    }
    .navbar {
      background: linear-gradient(90deg, #004aad, #002e6e);
      padding: 12px;
    }
    .navbar-brand {
      color: #fff !important;
      font-weight: 700;
    }
    .btn-blue {
      background-color: #007bff;
      border: none;
      color: #fff;
      border-radius: 25px;
      padding: 8px 20px;
      font-weight: 600;
      transition: 0.3s;
    }
    .btn-blue:hover {
      background-color: #00b7ff;
      color: #000;
      transform: scale(1.05);
    }
    .sidebar {
      background-color: #0d1333;
      width: 230px;
      position: fixed;
      top: 60px;
      bottom: 0;
      left: 0;
      overflow-y: auto;
      border-right: 1px solid #1f2a44;
    }
    .sidebar a {
      display: block;
      color: #9ab3ff;
      padding: 12px 20px;
      text-decoration: none;
      transition: 0.3s;
    }
    .sidebar a:hover {
      background-color: #1c2f60;
      color: #fff;
    }
    .content {
      margin-left: 240px;
      padding: 30px;
    }
    .card {
      background-color: #10183a;
      border: 1px solid #223469;
      border-radius: 12px;
      padding: 20px;
      color: #fff;
    }
    .profile-img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #00b7ff;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand">‚öôÔ∏è Painel ELO Commerce</a>
    <div class="ms-auto">
      <button id="homeBtn" class="btn btn-outline-light me-2">üè† In√≠cio</button>
      <button id="logoutBtn" class="btn btn-blue">Sair</button>
    </div>
  </div>
</nav>

<div class="sidebar">
  <a href="#" data-section="carteira">üí∞ Carteira</a>
  <a href="#" data-section="produtos">üì¶ Meus Produtos</a>
  <a href="#" data-section="vendas">üìä Minhas Vendas</a>
  <a href="#" data-section="afiliados">ü§ù Afiliados</a>
  <a href="#" data-section="perfil">üë§ Perfil</a>
</div>

<div class="content">
  <h2 class="text-info mb-4">Bem-vindo(a) ao seu painel</h2>
  <div id="conteudo">
    <p>Selecione uma op√ß√£o no menu para come√ßar.</p>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, getDocs, addDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAN_7vyt0XcOt6NvOE6MDoBCajUjhToCR0",
    authDomain: "elo-ecommerce-ecd87.firebaseapp.com",
    projectId: "elo-ecommerce-ecd87",
    storageBucket: "elo-ecommerce-ecd87.appspot.com",
    messagingSenderId: "375574231770",
    appId: "1:375574231770:web:78279cb6aac72c454703e3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const conteudo = document.getElementById("conteudo");

  onAuthStateChanged(auth, async user => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    // Exibe saldo inicial da carteira
    const carteiraRef = doc(db, "carteira", user.email);
    const snap = await getDoc(carteiraRef);
    if (!snap.exists()) {
      await setDoc(carteiraRef, { saldo: 0, atualizadoEm: new Date() });
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  document.getElementById("homeBtn").addEventListener("click", () => {
    window.location.href = "index.html";
  });

  // Troca de se√ß√£o
  document.querySelectorAll(".sidebar a").forEach(link => {
    link.addEventListener("click", async e => {
      e.preventDefault();
      const sec = link.getAttribute("data-section");
      await carregar(sec);
    });
  });

  async function carregar(sec) {
    conteudo.innerHTML = `<p class='text-info'>Carregando ${sec}...</p>`;

    switch (sec) {
      case "carteira":
        await mostrarCarteira();
        break;
      case "produtos":
        await mostrarProdutos();
        break;
      case "vendas":
        await mostrarVendas();
        break;
      case "afiliados":
        await mostrarAfiliados();
        break;
      case "perfil":
        await mostrarPerfil();
        break;
    }
  }

  async function mostrarCarteira() {
    const user = auth.currentUser;
    const refDoc = doc(db, "carteira", user.email);
    const snap = await getDoc(refDoc);
    const saldo = snap.exists() ? snap.data().saldo : 0;

    conteudo.innerHTML = `
      <div class="card text-center">
        <h4>Saldo dispon√≠vel</h4>
        <h2 class="text-success">R$ ${saldo.toFixed(2)}</h2>
        <button class="btn-blue mt-3" id="addFundos">Adicionar Fundos</button>
      </div>
    `;

    document.getElementById("addFundos").addEventListener("click", async () => {
      await setDoc(refDoc, { saldo: saldo + 10 }, { merge: true });
      alert("R$ 10,00 adicionados √† sua carteira!");
      mostrarCarteira();
    });
  }

  async function mostrarProdutos() {
    conteudo.innerHTML = `
      <div class="card">
        <h4>Meus Produtos</h4>
        <button class="btn-blue mb-3" id="novoProduto">+ Novo Produto</button>
        <div id="listaProdutos"></div>
      </div>
    `;

    document.getElementById("novoProduto").addEventListener("click", async () => {
      conteudo.innerHTML = `
        <div class="card">
          <h4>Criar Produto</h4>
          <input type="text" id="nomeProd" class="form-control mb-2" placeholder="Nome do produto">
          <textarea id="descProd" class="form-control mb-2" placeholder="Descri√ß√£o"></textarea>
          <input type="number" id="precoProd" class="form-control mb-2" placeholder="Pre√ßo">
          <input type="file" id="arquivoProd" class="form-control mb-3" accept="image/*,video/*">
          <button class="btn-blue w-100" id="salvarProd">Salvar</button>
        </div>
      `;

      document.getElementById("salvarProd").addEventListener("click", async () => {
        const user = auth.currentUser;
        const nome = nomeProd.value.trim();
        const preco = parseFloat(precoProd.value);
        const file = arquivoProd.files[0];

        if (!nome || !preco || !file) return alert("Preencha todos os campos!");

        const fileRef = ref(storage, `produtos/${user.uid}_${Date.now()}_${file.name}`);
        await uploadBytes(fileRef, file);
        const url = await getDownloadURL(fileRef);

        await addDoc(collection(db, "produtos"), {
          nome, preco, dono: user.email, arquivo: url, criadoEm: new Date()
        });

        alert("Produto criado com sucesso!");
        carregar("produtos");
      });
    });

    // Lista produtos
    const snap = await getDocs(collection(db, "produtos"));
    let html = "";
    snap.forEach(docSnap => {
      const d = docSnap.data();
      html += `
        <div class="border p-3 mb-2 rounded bg-dark">
          <strong>${d.nome}</strong> ‚Äî R$ ${d.preco}
          <br><img src="${d.arquivo}" width="120">
        </div>
      `;
    });
    document.getElementById("listaProdutos").innerHTML = html || "<p>Nenhum produto ainda.</p>";
  }

  async function mostrarVendas() {
    conteudo.innerHTML = `<div class="card"><h4>Minhas Vendas</h4><p>Nenhuma venda encontrada.</p></div>`;
  }

  async function mostrarAfiliados() {
    conteudo.innerHTML = `<div class="card"><h4>Afiliados</h4><p>Em breve...</p></div>`;
  }

  async function mostrarPerfil() {
    const user = auth.currentUser;
    const ref = doc(db, "usuarios", user.email);
    const snap = await getDoc(ref);
    const dados = snap.exists() ? snap.data() : {};

    conteudo.innerHTML = `
      <div class="card text-center">
        <img src="${dados.foto || "https://via.placeholder.com/100"}" class="profile-img mb-3">
        <input type="file" id="novaFoto" class="form-control mb-2" accept="image/*">
        <input type="text" id="novoNome" class="form-control mb-2" placeholder="Seu nome" value="${dados.nome || ""}">
        <textarea id="novaBio" class="form-control mb-3" placeholder="Sua bio">${dados.bio || ""}</textarea>
        <button id="salvarPerfil" class="btn-blue w-100">Salvar Altera√ß√µes</button>
      </div>
    `;

    document.getElementById("salvarPerfil").addEventListener("click", async () => {
      let fotoURL = dados.foto || "";
      if (novaFoto.files.length > 0) {
        const file = novaFoto.files[0];
        const fileRef = ref(storage, `usuarios/${user.uid}.jpg`);
        await uploadBytes(fileRef, file);
        fotoURL = await getDownloadURL(fileRef);
      }

      await setDoc(ref, {
        nome: novoNome.value,
        bio: novaBio.value,
        foto: fotoURL,
        atualizadoEm: new Date()
      });

      alert("Perfil atualizado!");
      mostrarPerfil();
    });
  }
</script>
</body>
  </html>
